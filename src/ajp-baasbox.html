<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="ajp-baasbox-user-data.html">

<dom-module id="ajp-baasbox">

	<script src="../scripts/jquery.min.js"></script>
	<script src="../baasbox/baasbox-0.8.4.min.js"></script>

	<template>
		<app-location route="{{route}}"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

		<iron-localstorage
				name="ajp-baasbox"
				value="[[baasbox]]"
				on-iron-localstorage-load-empty="_initializeBaasbox"></iron-localstorage>

    <ajp-baasbox-user-data id="user" cart="{{user}}"></ajp-baasbox-user-data>
	</template>

	<script>

		Polymer({

			is: 'ajp-baasbox',

			properties: {

			},

      ready: function() {
				this._setEndPoint("https://baasbox.elopparty.com");
				this._setAppCode("1234567890");
      },

      signOn: function(name,password) {
				this.fire('fireProgressShow');
				var signOnThis = this;
				BaasBox.login(name, password)
				.done(function (user) {
					signOnThis.fire('fireSignOnClear');
					signOnThis.set('route.path', '/user-info');
					signOnThis.fire('fireProgressHide');
				})
				.fail(function (err) {
					signOnThis.fire('fireSignOnClear');
					signOnThis.fire('fireShowSnack', {message: 'Sign on failed.'});
					signOnThis.fire('fireProgressHide');
				});
      },

			getCurrentUser: function() {
				return BaasBox.getCurrentUser();
			},

			currentUser: function() {
				BaasBox.fetchCurrentUser()
				.done(function(res) {
					console.log('res ', res['data']);
				})
				.fail(function(error) {
					console.log('error ', error);
				});
			},

      signUp: function(name,password) {
				this.fire('fireProgressShow');
				var signUpThis = this;
				BaasBox.fetchUserProfile(name)
				.done(function(res) {
					signUpThis.fire('fireSignUpClear');
					signUpThis.fire('fireShowSnack', {message: 'User Exists.'});
					signUpThis.fire('fireProgressHide');
				})
				.fail(function(error) {
					BaasBox.signup(name, password)
					.done(function (res) {
						signUpThis.fire('fireSignUpClear');
						signUpThis.set('route.path', '/user-info');
						signUpThis.fire('fireProgressHide');
					})
					.fail(function (error) {
						signUpThis.fire('fireSignUpClear');
						signUpThis.fire('fireShowSnack', {message: 'Network error. User failed to signup.'});
						signUpThis.fire('fireProgressHide');
					});
				});
      },

			_setAppCode(appCode) {
				BaasBox.appcode = appCode;
			},

			_setEndPoint(endPoint) {
				BaasBox.setEndPoint(endPoint);
			},

      _initializeBaasbox: function() {

      }

		});

	</script>

</dom-module>
