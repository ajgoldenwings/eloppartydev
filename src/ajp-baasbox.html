<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="ajp-baasbox">

	<script src="../scripts/jquery.min.js"></script>
	<script src="../baasbox/baasbox-0.8.4.min.js"></script>

	<template>
		<app-location route="{{route}}"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>
	</template>

	<script>

		Polymer({

			is: 'ajp-baasbox',

			properties: {

			},

			ready: function() {
				this._setEndPoint("https://baasbox.elopparty.com");
				this._setAppCode("1234567890");

				this.addEventListener('eventAdd',           this._fireAction);
				this.addEventListener('eventsLoad',         this._fireAction);
				this.addEventListener('passwordChange',     this._fireAction);
				this.addEventListener('passwordTestCurrent',this._fireAction);
				this.addEventListener('signOff',            this._fireAction);
				this.addEventListener('signOn',             this._fireAction);
				this.addEventListener('signUp',             this._fireAction);
			},

			_fireAction: function(event) {
				switch(event.type) {
					case 'eventAdd':           this.eventAdd(event.detail.title,event.detail.startTime,event.detail.length);break;
					case 'eventsLoad':         this.eventsLoad(event.detail.page);                                     break;
					case 'passwordChange':     this.passwordChange(     event.detail.callbackSuccess,event.detail.callbackFail,event.detail.passwordCurrent,event.detail.password);break;
					case 'passwordTestCurrent':this.currentPasswordTest(event.detail.callbackSuccess,event.detail.callbackFail,event.detail.password);                             break;
					case 'signOff':            this.signOff(            event.detail.callbackSuccess,event.detail.callbackFail);                                                   break;
					case 'signOn':             this.signOn(             event.detail.callbackSuccess,event.detail.callbackFail,event.detail.name, event.detail.password);          break;
					case 'signUp':             this.signUp( event.detail.name, event.detail.password);                  break;
					default:console.error('There was no matching details for the event that was listened by baasbox.', event);
				}
			},

			eventAdd: function(title,startTime,length) {
				this.fire('App', {typeFire: 'progressShow'});
				var elop_event = new Object();
				var thisFunc = this;
				elop_event.title = title;
				elop_event.date = startTime;
				elop_event.length = length;
				BaasBox.save(elop_event, "elop_events")
					.done(function(res) {
						thisFunc.fire('App', {typeFire: 'showSnack', message: 'Your event was added.'});
						thisFunc.fire('App', {typeFire: 'progressHide'});
						thisFunc.fire('Main', {typeFire: 'unshiftEvent', event: res});
						thisFunc.set('route.path', '/');
					})
					.fail(function(error) {
					thisFunc.fire('App', {typeFire: 'showSnack', message: 'Failed to add event.'});
						thisFunc.fire('App', {typeFire: 'progressHide'});
						thisFunc.set('route.path', '/');
					})

			},

			eventsLoad: function(page) {
				var thisFunc = this;
				BaasBox.loadCollectionWithParams('elop_events', {page: page, recordsPerPage: 5, orderBy: "_creation_date DESC"}).done(function(res) {
					thisFunc.fire('Main', {typeFire: 'eventsPopulate', events: res, isEnd: res.length==0});
				})
				.fail(function(error) {
					thisFunc.fire('App', {typeFire: 'showSnack', message: 'Failed to load events.'});
					thisFunc.fire('Main', {typeFire: 'turnOffLoadingEvents'});
				});
			},

			passwordChange: function(callbackSuccess, callbackFail, passwordCurrent, password) {
				BaasBox.changePassword(passwordCurrent, password)
				.done(function(res) { callbackSuccess();})
				.fail(function(error) { callbackFail();});
			},

			currentPasswordTest: function(callbackSuccess, callbackFail, password) {
				BaasBox.login(this._getUserName(), password)
				.done(function (user) { callbackSuccess();})
				.fail(function (err) { callbackFail();});
			},

			signOff: function(callbackSuccess, callbackFail) {
				if(navigator.onLine) {
					BaasBox.logout()
					.done(function (user) { callbackSuccess();})
					.fail(function (err) { callbackFail();});
				} else {
					var COOKIE_KEY = "baasbox-cookie";
					if(window.Zepto && window.localStorage) {
						window.localStorage.removeItem(COOKIE_KEY);
					} else {
						$.cookie(COOKIE_KEY, null);
					}
					console.error('Forced Sign Off');
					callbackSuccess();
				}
			},

			signOn: function(callbackSuccess, callbackFail, name, password) {
				BaasBox.login(name || this._getUserName(), password)
				.done(function (user) { callbackSuccess();})
				.fail(function (err) { callbackFail();});
			},

			signUp: function(name,password) {
				this.fire('App', {typeFire: 'progressShow'});
				var thisFunc = this;
				BaasBox.fetchUserProfile(name)
				.done(function(res) {
					thisFunc.fire('Authentication', {typeFire: 'signUpClear'});
					thisFunc.fire('App', {typeFire: 'showSnack', message: 'User Exists.'});
					thisFunc.fire('App', {typeFire: 'progressHide'});
				})
				.fail(function(error) {
					BaasBox.signup(name, password)
					.done(function (res) {
						thisFunc.fire('Authentication', {typeFire: 'signUpClear'});
						thisFunc.set('route.path', '/');
						thisFunc.fire('App', {typeFire: 'populateUserName', name: user.username});
						thisFunc.fire('App', {typeFire: 'progressHide'});
					})
					.fail(function (error) {
						thisFunc.fire('Authentication', {typeFire: 'signUpClear'});
						// TODO visibleByAnonymousUsers - need to add usernames, https://github.com/baasbox/baasbox/wiki/Plugin-Engine
						thisFunc.fire('App', {typeFire: 'showSnack', message: 'Sign up failed. Try again.'});
						thisFunc.fire('App', {typeFire: 'progressHide'});
					});
				});
			},


			getCurrentUser: function() {
				return BaasBox.getCurrentUser();
			},

			_getUserName: function() {
				return this.getCurrentUser().username;
			},

			_setAppCode(appCode) {
				BaasBox.appcode = appCode;
			},

			_setEndPoint(endPoint) {
				BaasBox.setEndPoint(endPoint);
			},

			_setUserName: function(name) {
				this.userName = name;
			},

			_initializeBaasbox: function() {

			}

		});

	</script>

</dom-module>
