<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="ajp-baasbox-user-data.html">

<dom-module id="ajp-baasbox">

	<script src="../scripts/jquery.min.js"></script>
	<script src="../baasbox/baasbox-0.8.4.min.js"></script>

	<template>
		<app-location route="{{route}}"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

		<iron-localstorage
				name="ajp-baasbox"
				value="[[baasbox]]"
				on-iron-localstorage-load-empty="_initializeBaasbox"></iron-localstorage>

    <ajp-baasbox-user-data id="user" cart="{{user}}"></ajp-baasbox-user-data>
	</template>

	<script>

		Polymer({

			is: 'ajp-baasbox',

			properties: {

			},

      ready: function() {
				this._setEndPoint("https://baasbox.elopparty.com");
				this._setAppCode("1234567890");
      },

      signOff: function() {
				this.fire('fireProgressShow');
				var signOffThis = this;

				if(navigator.onLine){
					BaasBox.logout()
					.done(function (user) {
						signOffThis.set('route.path', '/signon');
						signOffThis.fire('fireProgressHide');
					})
					.fail(function (err) {
						signOffThis.set('route.path', '/signon');
						signOffThis.fire('fireShowSnack', {message: 'Logoff failed.'});
						signOffThis.fire('fireProgressHide');
					});
				} else {
					// Force Sign Off
  			  var COOKIE_KEY = "baasbox-cookie";
					if(window.Zepto && window.localStorage) {
						window.localStorage.removeItem(COOKIE_KEY);
					} else {
						$.cookie(COOKIE_KEY, null);
					}
					signOffThis.set('route.path', '/signon');
					signOffThis.fire('fireProgressHide');
				}
      },

      signOn: function(name,password) {
				this.fire('fireProgressShow');
				var signOnThis = this;
				BaasBox.login(name, password)
				.done(function (user) {
					signOnThis.fire('fireSignOnClear');
					signOnThis.set('route.path', '/');
					console.log(user.username);
					signOnThis.fire('firePopulateUserName', {name: user.username});
					signOnThis.fire('fireProgressHide');
				})
				.fail(function (err) {
					signOnThis.fire('fireSignOnClear');
					signOnThis.fire('fireShowSnack', {message: 'Sign on failed.'});
					signOnThis.fire('fireProgressHide');
				});
      },

      signUp: function(name,password) {
				console.log(name);
				this.fire('fireProgressShow');
				var signUpThis = this;
				BaasBox.fetchUserProfile(name)
				.done(function(res) {
					signUpThis.fire('fireSignUpClear');
					signUpThis.fire('fireShowSnack', {message: 'User Exists.'});
					signUpThis.fire('fireProgressHide');
				})
				.fail(function(error) {
					BaasBox.signup(name, password)
					.done(function (res) {
						signUpThis.fire('fireSignUpClear');
						signUpThis.set('route.path', '/');
						signUpThis.fire('firePopulateUserName', {name: user.username});
						signUpThis.fire('fireProgressHide');
					})
					.fail(function (error) {
						signUpThis.fire('fireSignUpClear');
						// TODO visibleByAnonymousUsers - need to add usernames, https://github.com/baasbox/baasbox/wiki/Plugin-Engine
						signUpThis.fire('fireShowSnack', {message: 'Sign up failed. Try again.'});
						signUpThis.fire('fireProgressHide');
					});
				});
      },

			getCurrentUser: function() {
				return BaasBox.getCurrentUser();
			},

			getUserName: function() {
				return this.userName;
			},

			_setAppCode(appCode) {
				BaasBox.appcode = appCode;
			},

			_setEndPoint(endPoint) {
				BaasBox.setEndPoint(endPoint);
			},

			_setUserName: function(name) {
				this.userName = name;
			},

      _initializeBaasbox: function() {

      }

		});

	</script>

</dom-module>
