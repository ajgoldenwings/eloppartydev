<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="ajp-baasbox-user-data.html">

<dom-module id="ajp-baasbox">

	<script src="../scripts/jquery.min.js"></script>
	<script src="../baasbox/baasbox-0.8.4.min.js"></script>

	<template>
		<app-location route="{{route}}"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

		<iron-localstorage
				name="ajp-baasbox"
				value="[[baasbox]]"
				on-iron-localstorage-load-empty="_initializeBaasbox"></iron-localstorage>

    <ajp-baasbox-user-data id="user" cart="{{user}}"></ajp-baasbox-user-data>
	</template>

	<script>

		Polymer({

			is: 'ajp-baasbox',

			properties: {

			},

      ready: function() {
				this._setEndPoint("https://baasbox.elopparty.com");
				this._setAppCode("1234567890");

				this.addEventListener('passwordChange',     this._fireAction);
				this.addEventListener('passwordTestCurrent',this._fireAction);
				this.addEventListener('signOff',            this._fireAction);
				this.addEventListener('signOn',             this._fireAction);
				this.addEventListener('signUp',             this._fireAction);
      },

			_fireAction: function(event) {
				switch(event.type) {
					case 'passwordChange':     this.passwordChange(event.detail.passwordCurrent,event.detail.password);break;
					case 'passwordTestCurrent':this.currentPasswordTest(event.detail.password);                        break;
					case 'signOff':            this.signOff();                                                         break;
					case 'signOn':             this.signOn(event.detail.name, event.detail.password);                  break;
					case 'signUp':             this.signUp(event.detail.name, event.detail.password);                  break;
					default:console.error('There was no matching details for the event that was listened by baasbox.', event);
				}
			},

			passwordChange: function(passwordCurrent, password) {
				this.fire('App', {typeFire: 'progressShow'});
				var thisFunc = this;
				BaasBox.changePassword(passwordCurrent, password)
				.done(function(res) {
					thisFunc.fire('Main', {typeFire: 'clearForms'});
					thisFunc.fire('Main', {typeFire: 'clearPasswordConfirm'});
					// thisFunc.set('route.path', '/settings');
					thisFunc.fire('App', {typeFire: 'showSnack', message: 'Password changed.'});
					// thisFunc.fire('App', {typeFire: 'progressHide'});
					thisFunc.signOn(thisFunc._getUserName(),password);
				})
				.fail(function(error) {
					thisFunc.fire('Main', {typeFire: 'clearForms'});
					thisFunc.fire('Main', {typeFire: 'clearPasswordConfirm'});
					thisFunc.set('route.path', '/settings');
					thisFunc.fire('App', {typeFire: 'showSnack', message: 'Something went wrong when changing your password.'});
					thisFunc.fire('App', {typeFire: 'progressHide'});
				});
			},

      currentPasswordTest: function(password) {
				this.fire('App', {typeFire: 'progressShow'});
				var thisFunc = this;
				BaasBox.login(this._getUserName(), password)
				.done(function (user) {
					thisFunc.set('route.path', '/change-password-new');
					thisFunc.fire('Main', {typeFire: 'clearForms'});
					thisFunc.fire('App', {typeFire: 'progressHide'});
					thisFunc.fire('Main', {typeFire: 'passwordCurrentConfirmSet'});
					thisFunc.fire('Main', {typeFire: 'passwordStoreCurrent', password: password});
				})
				.fail(function (err) {
					thisFunc.fire('Main', {typeFire: 'clearForms'});
					thisFunc.fire('App', {typeFire: 'showSnack', message: 'That is not your current password.'});
					thisFunc.fire('App', {typeFire: 'progressHide'});
				});
      },

      signOff: function() {
				this.fire('App', {typeFire: 'progressShow'});
				var thisFunc = this;
				if(navigator.onLine){
					BaasBox.logout()
					.done(function (user) {
						thisFunc.set('route.path', '/signon');
						thisFunc.fire('App', {typeFire: 'progressHide'});
					})
					.fail(function (err) {
						thisFunc.set('route.path', '/signon');
						thisFunc.fire('App', {typeFire: 'showSnack', message: 'Logoff failed.'});
						thisFunc.fire('App', {typeFire: 'progressHide'});
					});
				} else {
					// Force Sign Off
  			  var COOKIE_KEY = "baasbox-cookie";
					if(window.Zepto && window.localStorage) {
						window.localStorage.removeItem(COOKIE_KEY);
					} else {
						$.cookie(COOKIE_KEY, null);
					}
					thisFunc.set('route.path', '/signon');
					thisFunc.fire('App', {typeFire: 'progressHide'});
				}
      },

      signOn: function(name,password) {
				this.fire('App', {typeFire: 'progressShow'});
				var thisFunc = this;
				BaasBox.login(name, password)
				.done(function (user) {
					thisFunc.set('route.path', '/');
					thisFunc.fire('Authentication', {typeFire: 'signOnClear'});
					thisFunc.fire('App', {typeFire: 'populateUserName', name: user.username});
					thisFunc.fire('App', {typeFire: 'progressHide'});
				})
				.fail(function (err) {
					thisFunc.fire('Authentication', {typeFire: 'signOnClear'});
					thisFunc.fire('App', {typeFire: 'showSnack', message: 'Sign on failed.'});
					thisFunc.fire('App', {typeFire: 'progressHide'});
				});
      },

      signUp: function(name,password) {
				this.fire('App', {typeFire: 'progressShow'});
				var thisFunc = this;
				BaasBox.fetchUserProfile(name)
				.done(function(res) {
					thisFunc.fire('Authentication', {typeFire: 'signUpClear'});
					thisFunc.fire('App', {typeFire: 'showSnack', message: 'User Exists.'});
					thisFunc.fire('App', {typeFire: 'progressHide'});
				})
				.fail(function(error) {
					BaasBox.signup(name, password)
					.done(function (res) {
						thisFunc.fire('Authentication', {typeFire: 'signUpClear'});
						thisFunc.set('route.path', '/');
						thisFunc.fire('App', {typeFire: 'populateUserName', name: user.username});
						thisFunc.fire('App', {typeFire: 'progressHide'});
					})
					.fail(function (error) {
						thisFunc.fire('Authentication', {typeFire: 'signUpClear'});
						// TODO visibleByAnonymousUsers - need to add usernames, https://github.com/baasbox/baasbox/wiki/Plugin-Engine
						thisFunc.fire('App', {typeFire: 'showSnack', message: 'Sign up failed. Try again.'});
						thisFunc.fire('App', {typeFire: 'progressHide'});
					});
				});
      },

			getCurrentUser: function() {
				return BaasBox.getCurrentUser();
			},

			_getUserName: function() {
				return this.getCurrentUser().username;
			},

			_setAppCode(appCode) {
				BaasBox.appcode = appCode;
			},

			_setEndPoint(endPoint) {
				BaasBox.setEndPoint(endPoint);
			},

			_setUserName: function(name) {
				this.userName = name;
			},

      _initializeBaasbox: function() {

      }

		});

	</script>

</dom-module>
