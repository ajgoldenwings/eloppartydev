<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="ajp-media-stream">
	<template>

	</template>
	<script>
		Polymer({
			is: "ajp-media-stream",

			properties: {
				appStorage: {
					reflectToAttribute: true,
					type: Object
				},

				mediaStream: {
					type: Object,
					reflectToAttribute: true
				}
			},

			ready: function() {
				this.addEventListener('allowAccessToCamera',this._fireAction);
				this.addEventListener('setMedia',           this._fireAction);
				this.addEventListener('startCamera',        this._fireAction);
				console.log('Media Ready');
			},

			_fireAction: function(event) {
				switch(event.type) {
					case 'allowAccessToCamera':this._allowAccessToCamera(event.detail.callbackNeedUserPermissionSuccess,event.detail.callbackNeedUserPermissionFail);break;
					case 'setMedia':           this._setMedia(event.detail.mediaStream);                                                                             break;
					case 'startCamera':        this._startCamera(event.detail.callbackSuccess,event.detail.callbackFail,event.detail.callbackNeedUserPermission);    break;
					default:console.error('There was no matching details for the event that was listened by the media stream component.', event);
				}
			},

			_allowAccessToCamera: function(callbackNeedUserPermissionSuccess, callbackNeedUserPermissionFail) {
				var that = this;
				navigator.getUserMedia(
					{
						video: {
				 			mandatory: {
				 				minWidth: 400,
				 				minHeight: 400,
				 				maxWidth: 400,
				 				maxHeight: 400
				 			}
				 		}
					},
					function(localMediaStream) {
						callbackNeedUserPermissionSuccess(localMediaStream);
					}, function(err) {
						callbackNeedUserPermissionFail(err);
					}
				);
			},

			_setMedia: function(mediaStream) {
				this.mediaStream = mediaStream;
			},

			_startCamera: function(callbackSuccess,callbackFail,callbackNeedUserPermission) {
				console.log('Starting Camera');
				navigator.getUserMedia = this._getUserMedia();

				if (this.appStorage.allowedCamera === undefined || this.appStorage.allowedCamera == false) {
					if (navigator.getUserMedia) {
						callbackNeedUserPermission();
					} else {
						callbackFail();
					}
				} else {
					callbackSuccess();
				}
			},

			_getUserMedia: function() {
				return (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
			}
		});
	</script>
</dom-module>